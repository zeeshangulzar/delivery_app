<script src="//maps.google.com/maps/api/js?key=AIzaSyBRXZRZ2D2sB0lqQhBDsm619tV471Y5zFw"></script>
<script src="//cdn.rawgit.com/mahnunchik/markerclustererplus/master/dist/markerclusterer.min.js"></script>
<script src='//cdn.rawgit.com/printercu/google-maps-utility-library-v3-read-only/master/infobox/src/infobox_packed.js' type='text/javascript'></script>

<script type="text/javascript">
var draw = false;
var polygons = [];
var index = 0;

handler = Gmaps.build('Google');

$(function() {
   handler.buildMap({ provider: {}, internal: {id: 'map'}}, function(){
      var Qatar = [
         {"lat":25.426063,"lng":51.181199}
      ];
      handler.bounds.extendWith(handler.addPolygons(<%=raw @hash.to_json %>,{ strokeColor: '#F90505'}));
      google.maps.event.addListener(handler.map.getServiceObject(),'click',function(event){
         if (draw == true)
         {
            if (index == 0)
            {
               handler.bounds.extendWith(handler.addPolygons(
                  [[
                     { lat: event.latLng.lat(), lng: event.latLng.lng() }
                  ]],{ strokeColor: '#F90505'}
               ));
            }
            else
            {
               handler.bounds.extendWith(
                  handler.addPolygons(
                  [
                     [
                        {lat: polygons[index-1]['lat'], lng: polygons[index-1]['lng']},
                        {lat: event.latLng.lat(), lng: event.latLng.lng()}
                     ]
                  ],{ strokeColor: '#F90505'}
               ));
            }
           polygons.push({lat:event.latLng.lat(), lng:event.latLng.lng()});
           index += 1;
         }
      });
      handler.map.centerOn(Qatar);
      handler.fitMapToBounds();
      handler.getMap().setZoom(9);
   });
});

function save_polygons(){
   draw = !draw;
   if (draw == false)
   {
      handler.bounds.extendWith(handler.addPolygons([polygons],{ strokeColor: '#F90505'}));
      document.getElementById("draw_btn").className = "btn btn-info"
      name_field = document.getElementById("name_field");
      var name = name_field.value;
      name_field.style.display = "none";
      if (index != 0)
      {
         handler.bounds.extendWith(handler.addPolygons(
            [
               [
                  {lat:  polygons[index-1]['lat'], lng: polygons[index-1]['lng']},
                  {lat:  polygons[0]['lat'], lng: polygons[0]['lng']}
               ]
            ],{ strokeColor: '#F90505'}
         ));
         jQuery.ajax({
            data: { name, polygons },
            type: 'get',
            url: "/save_polygon"
         });
      }
      name_field.value = "";
      polygons = [];
      index = 0;
   }
   else
   {
      document.getElementById("draw_btn").className = "btn btn-primary"
      document.getElementById("name_field").style.display = "block"
   }
}
</script>

<div class="right_col" role="main">
  <div class="">
    <div class="page-title">
      <div class="title_left" style="width: 20%;">
        <h3>Map</h3>
      </div>
         <button id="draw_btn" class="btn btn-info" style="float: right;" onclick='save_polygons()'><i class="fa fa-pencil"></i></button>
         <%= text_field_tag 'name', nil, placeholder: "Name...", id: "name_field", style: "display: none; float: right; width: 200px;", class: "form-control"%>
      <div>
      </div>
      <div style='width: 100%;'>
        <div id="map" style='width: 100%; height: 500px;'></div>
      </div>
    </div>
  </div>
</div>
