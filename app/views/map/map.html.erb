<script src="//maps.google.com/maps/api/js?key=AIzaSyBRXZRZ2D2sB0lqQhBDsm619tV471Y5zFw"></script>
<script src="//cdn.rawgit.com/mahnunchik/markerclustererplus/master/dist/markerclusterer.min.js"></script>
<script src='//cdn.rawgit.com/printercu/google-maps-utility-library-v3-read-only/master/infobox/src/infobox_packed.js' type='text/javascript'></script>

<script type="text/javascript">
var draw = false;
var polygons = [];
var index = 0;

handler = Gmaps.build('Google');

$(function() {

   jQuery(function(){
      jQuery('#menu_toggle').click();
   });

   handler.buildMap({ provider: {}, internal: {id: 'map'}}, function(){
      var Qatar = [
         {"lat":25.426063,"lng":51.181199}
      ];
      handler.bounds.extendWith(handler.addPolygons(<%=raw @hash.to_json %>,{ strokeColor: '#FFBF00'}));
      google.maps.event.addListener(handler.map.getServiceObject(),'click',function(event){
         if (draw == true)
         {
            if (index == 0)
            {
               handler.bounds.extendWith(handler.addPolygons(
                  [[
                     { lat: event.latLng.lat(), lng: event.latLng.lng() },
                     { lat: event.latLng.lat(), lng: event.latLng.lng() }
                  ]],{ strokeColor: '#FFBF00'}
               ));
            }
            else
            {
               handler.bounds.extendWith(
                  handler.addPolygons(
                  [
                     [
                        {lat: polygons[index-1]['lat'], lng: polygons[index-1]['lng']},
                        {lat: event.latLng.lat(), lng: event.latLng.lng()}
                     ]
                  ],{ strokeColor: '#FFBF00'}
               ));
            }
           polygons.push({lat:event.latLng.lat(), lng:event.latLng.lng()});
           index += 1;
         }
      });
      handler.map.centerOn(Qatar);
      handler.fitMapToBounds();
      handler.getMap().setZoom(9);
   });

   $("#map_li").on("click", function (){
      document.getElementById("draw_btn").style.display = "none";
   });
   $("#list_li").on("click", function (){
      document.getElementById("draw_btn").style.display = "block";
   });
   if (getURLParameter('list') == 'true')
   {
    $('#map_tab a[href="#list_view"]').tab('show');
   }
});

function save_polygons(){
   draw = !draw;
   if (draw == false)
   {
      document.getElementById("draw_btn").className = "btn btn-info"
      if (index != 0)
      {
        $("#polygon_name").modal();
        handler.bounds.extendWith(handler.addPolygons(
          [
            [
              {lat:  polygons[index-1]['lat'], lng: polygons[index-1]['lng']},
              {lat:  polygons[0]['lat'], lng: polygons[0]['lng']}
            ]
          ],{ strokeColor: '#FFBF00'}
        ));
        handler.bounds.extendWith(handler.addPolygons([polygons],{ strokeColor: '#FFBF00'}));
      }
   }
   else
   {
      document.getElementById("draw_btn").className = "btn btn-primary"
   }
}
function send_polygons(){
  name_filed = document.getElementById("name_field");
  name = name_field.value;
  jQuery.ajax({
    data: { name, polygons },
    type: 'get',
    url: "/save_polygon"
  });
  name_field.value = "";
  polygons = [];
  index = 0;
}
</script>

<div class="right_col" role="main">
  <div class="">
    <div class="page-title">
      <div class="title_left" style="width: 20%;">
        <h3>Map</h3>
      </div>
    </div>
      <div id="polygon_name" class="modal fade" role="dialog">
        <div class="modal-dialog" style="padding-top: 120px;">
          <!-- Modal content-->
          <div class="modal-content">
            <div class="modal-header colors">
              <button type="button" class="close colors" data-dismiss="modal" method="reset">X</button>
              <h4 class="modal-title">Polygon</h4>
            </div>
            <div class="modal-body">
              <%= text_field_tag 'name', nil, required: true, placeholder: "Name...", id: "name_field", class: "form-control"%>
              <br>
              <button type="button" class="btn btn-info" style="float; right;" data-dismiss="modal" onclick='send_polygons()'>Done</button>
            </div>
          </div>
        </div>
      </div>
      <div class="row">
        <div class="col-md-12 col-sm-12 col-xs-12">
          <div class="x_panel">
              <div class="col-md-8 col-sm-12 col-xs-12 form-group" style="padding: 0px 4px 0px 0px; height: 100%;">
                <div id="map" style='width: 100%; height: 540px;'></div>
              </div>
              <div class="col-md-4 col-sm-12 col-xs-12 form-group" style="padding: 0px;">
                <%= render "index" %>
              </div>
          </div>
        </div>
      </div>
  </div>
</div>
